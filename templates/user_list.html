{% extends 'base.html' %}
{% load static %}
<!--重写title-->
{% block title %} 以太坊智能合约漏洞检测系统 {% endblock %}
<!--区域1保持父模板默认状态-->
<!--对父模板的区域2进行重写-->
{% block content %}
<div class="container" style="width: 98%;">
   <form id="toolbar" class="form-inline" role="form">
   {% csrf_token %}

         <!--  <div class="form-group">
                        <input type="text"  id="username" name="username" class="form-control"  placeholder="用户名" onkeyup="this.value=this.value.replace(/[, ]/g,'')">
                    </div>
           <div class="form-group">
               <input type="text"  id="password" name="password" class="form-control"  placeholder="密码" onkeyup="this.value=this.value.replace(/[, ]/g,'')">
           </div>
           <button type="button" id="searchContract" class="btn btn-default btn-info">搜索</button> -->
 </form>
    {#    //点新增按钮，弹出模态框#}
<!-- 模态框（Modal） -->
{#    //点编辑按钮，弹出模态框#}
    <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" id="editModal">
        <div class="modal-dialog modal-lg" role="document" >
            <div class="modal-content" style="border-color: black">
                <div class="modal-header">
                       <p class="text-center"><h4 class="modal-title" id="myModalLabel" >编辑用户信息</h4></p>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form action="" class="form-horizontal" id="model-form">
                          {% csrf_token %}
                         <div class="form-group">
                            <div class="col-sm-9">
                                <input type="hidden" name="id" class="form-control" id="modal_id"  >
                            </div>
                         </div>
                         <div class="form-group">
                            <label for="" class="col-sm-2 control-label">姓名</label>
                            <div class="col-sm-9">
                                <input type="text" name="username" class="form-control" id="modal_name">
                            </div>
                        </div>
                         <div class="form-group">
                            <label for="" class="col-sm-2 control-label">密码</label>
                            <div class="col-sm-9">
                                <input type="text" name="password" class="form-control" id="modal_age">
                            </div>
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary"  id="sava-edit-btn">保存</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>
{#    //点删除按钮，弹出模态框#}
     <div class="modal fade" id="delModal" tabindex="-1" role="dialog" aria-labelledby="delModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="delModalLabel">操作提示:</h4>
                </div>
                <div class="modal-body">
                        <form action="" class="form-horizontal">
                          {% csrf_token %}
                            <input type="hidden" id="del_ids" name="ids" value="">
                            <h5 id="delBody">确定要删除选中的数据？</h5>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="deleteIds">确定删除</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消
                    </button>
                </div>
           </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
    <table id="table" class="table table-striped"></table>
</div>
{% endblock content %}
{% block footer %}
    <script>
    var url = '/user/info';
    var columns = [
         {
            checkbox: true,
            visible: true                  //是否显示复选框
        },
        {
            field: 'username',
            title: '用户名'
        }, {
            field: 'password',
            title: '密码',
        },
        {
             field:'operate',
             title: '操作',
             width: 150,
             align: 'center',
             valign: 'middle',
             formatter: actionFormatter
         }
    ];

    $("#table").bootstrapTable({
        toolbar: '#toolbar',                //自定义工具按钮
        url: url,                           //请求后台的URL（*）
        method: 'get',                      //请求方式（*）
        cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
        pagination: true,                   //是否显示分页（*）
        pageSize: 10,                       //每页的记录行数（*）
        pageList: [10, 20, 50, 100, 'All'], //可供选择的每页的行数（*）
        sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
        pageNumber: 1,                      //初始化加载第一页，默认第一页
        //search: true,                       //是否显示表格搜索
       // showColumns: true,                  //是否显示所有的列
        //showRefresh: true,                  //是否显示刷新按钮
        minimumCountColumns: 2,             //最少允许的列数
        //height: 500,                      //行高，如果没有设置height属性，表格自动根据记录条数决定表格高度
        //showToggle: true,                   //是否显示详细视图和列表视图的切换按钮
        columns: columns,
        //detailView: true,                  //是否显示父子表
        //得到查询的参数，会在url后面拼接，如：?rows=5&page=2&sortOrder=asc&search_kw=&_=1564105760651
        queryParams: function (params) {
            //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
            var query_params = {
                page: (params.offset / params.limit) + 1,   //页码
                size: params.limit,    //页面大小
                username: $('#toolbar #username').val(),
                password: $('#toolbar #password').val(),
                //查询框中的参数传递给后台
                //search_kw: $('#search-keyword').val(), // 请求时向服务端传递的参数
            };
            return query_params;
        },

    });
    //得到查询的参数
   //操作栏的格式化
    function actionFormatter(value, row, index) {
            var result = "";
            result += '<a href="javascript:;" class="btn btn-primary" style="margin:4px" onclick="EditViewById(' + index+')" title="编辑">';
            result += '<span class="glyphicon glyphicon-pencil"></span></a>';

            return result;
        }
   //定义表格操作编辑按钮 title="编辑"
    function EditViewById(index){
        //alert(index);
{#        // 调出modal 框#}
        var row = $("#table").bootstrapTable('getData')[index];
        $("#modal_id").val(row.id);
        $("#modal_name").val(row.username);
        $("#modal_age").val(row.password);
        $("#editModal").modal();
    }
     //定义表格操作编辑删除 title="删除"
    function DeleteByIds(id){
        //alert(JSON.stringify(ids));
        //把ids的值给到隐藏输入框
        $('#del_ids').val(JSON.stringify(id));
        //调出删除模态框
        $("#delModal").modal();
    }

function user_save(){
    var $form = $("#model-form"); // The form instance
    $.ajax({
            cache: false,
            type: "POST", //方法类型
            dataType: "json",  //预期服务器返回的数据类型
            url: "/user/edit/", //url
            data: $form.serialize(),
            success: function(result){
                   //隐藏模态框
            $("#editModal").modal('hide');
            if (result.result== "success"){
                // 此处可以显示一个toastr消息
                alert('提交数据成功！')
                alert('请重新登录！')
                    {#刷新表格数据#}
                $("#table").bootstrapTable('refresh');
                window.location.href='{% url 'login' %}'
            }
            else {
                alert("检测失败")
            }
            },
            error: function () {
                alert('提交失败');
            }
        });

    }
  //点提交按钮，发请求
$('#sava-edit-btn').click(function(e) {
    user_save();
 })
$("#searchContract").click(function() {
      $("#table").bootstrapTable('refresh');
});
// 点确定按钮发delete请求
$("#deleteIds").click(function() {
    var del_ids = $('#del_ids').val();
    $.ajax({
        cache: false,
        url: "/user/delete/", //url
        type: "POST",  //方法类型
        dataType: "json",  //预期服务器返回的数据类型
        data: JSON.stringify({ids: del_ids}),
        success: function (result) {
            //隐藏模态框
            $("#delModal").modal('hide');
            if (result.result == "success"){
                // 此处可以显示一个toastr消息
                alert('删除成功！')
                $("#table").bootstrapTable('refresh');
            }
            else {
                alert("删除失败")
            }
        },
        error: function () {
                $("#delModal").modal('hide');
                // 此处可以显示一个toastr消息
                alert("删除失败,服务器异常")
            }
    });
     $.ajaxSetup({
          data:{csrfmiddlewaretoken:'{{ csrf_token }}'}
});
})
</script>
{% endblock footer %}

